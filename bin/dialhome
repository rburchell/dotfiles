#!/bin/sh
which nc >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "$0: nc is not installed, pre-requisite"
    exit 1
fi

if [ -f ~/.dialhome.pid ]; then
    kill -s 0 $(cat ~/.dialhome.pid) 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "$0: already running as pid $(cat ~/.dialhome.pid)"
        exit 1
    fi
fi

if [ -z $1 ]; then
    echo "$0: need a place to dial home to"
    exit 1
fi

DIALHOME_HOST=$1
DIALHOME_PORT=6531 # TODO: try a random port, try a few times before giving up
nc -w1 localhost $DIALHOME_PORT
if [ $? -eq 0 ]; then
    exit 0
fi

echo "$0: establishing tunnel"
ssh -o "ExitOnForwardFailure yes" -f -N -T -R ${DIALHOME_PORT}:localhost:22 $DIALHOME_HOST
pid=$(pgrep -f "ssh.*${DIALHOME_PORT}:localhost:22.*${DIALHOME_HOST}")

if [ $? -ne 0 ]; then
    echo "$0: error establishing dialhome on $DIALHOME_PORT"
    exit 1
fi

ssh $DIALHOME_HOST "mkdir .dialhome && echo ${DIALHOME_PORT} > .dialhome/$HOSTNAME"
echo "$pid" > ~/.dialhome.pid
echo "$0: tunnel established as pid $pid, port $DIALHOME_PORT"
