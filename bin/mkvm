#!/bin/bash

# Setup the LV
if [ $# -lt 1 ]; then 
    echo "usage: $0 <guest>"
    echo Creates a VM.
    exit 1
fi

GUEST=$1

echo "Creating new VM ${GUEST}"

EXISTS=`lvdisplay |grep ${GUEST}_drive`

if [[ "$EXISTS" != "" ]]
then
    echo "This GUEST has already been setup on the host!"
    echo "Aborting..."
    exit 1
fi

# Exit if variables not set or on error
set -o nounset
set -o errexit

# find a logical volume group to put the LV on
LVGS=""
LVG=""
for i in $(vgs -o vg_name --noheadings); do
    LVGS="$LVGS $i"
done
case "$LVGS" in
    *\ )
        echo "Select a LVG to put the VM onto."
        read -e tmplvg

        for i in "$LVGS"; do
            if [[ "$i" == "$tmplvg" ]]; then
                LVG="$tmplvg"
            fi
        done
        ;;
    *)
        LVG=$(echo $LVGS | tr -d '[[:space:]]') # I love shell scripting.
        echo "Putting the VM onto LVG $LVG"
        ;;
esac

if [[ "$LVG" == "" ]]; then
    echo "Please tell me what LVG to put the VM onto!"
    echo "Aborting..."
    exit 1
fi

echo "Please enter LV size. Make sure you include the unit. (8G):"
read -e ROOTSIZE

if [[ "$ROOTSIZE" == "" ]]; then
    ROOTSIZE="8G"
fi

DEFAULT_DISTRO="centos-7.0"
# avoiding the indirection would be nice, but this isn't working on sky.
# virt-builder $DEFAULT_DISTRO --output /dev/$LVG/dns --hostname dns.vm
echo "Select distro ($DEFAULT_DISTRO):"
read -e DISTRO
if [[ "$DISTRO" == "" ]]; then
    DISTRO="$DEFAULT_DISTRO"
fi

echo "Enter hostname ($GUEST.vm):"
read -e HOSTNAME
if [[ "$HOSTNAME" == "" ]]; then
    HOSTNAME=${GUEST}.vm
fi

echo "Total RAM in MB? (256):"
read -e RAM
if [[ "$RAM" == "" ]]; then
    RAM=256
fi

echo "Total VCPUs? (2):"
read -e VCPUS
if [[ "$VCPUS" == "" ]]; then
    VCPUS=2
fi


echo "Setting up $HOSTNAME running $DISTRO"
echo " VCPUs: $VCPUS"
echo " Disk: $ROOTSIZE"
echo " RAM: $RAM"
echo "Press enter to continue or ctrl-c to cancel."
read

INSTALL_PACKAGES=""
COMMANDS=""
FIRSTBOOT_COMMAND=""

if [[ "$DISTRO" == "$DEFAULT_DISTRO" ]]; then
    INSTALL_PACKAGES="--install zsh,git,avahi,avahi-tools,vim,yum-cron"
    COMMANDS="
    yum -y update
    systemctl enable avahi-daemon.service
    systemctl start avahi-daemon.service
    "
else
    echo "WARNING: Unrecognised distro, I may not be able to customise the setup properly."
fi

if [[ "$COMMANDS" != "" ]]; then
    FIRSTBOOT_COMMAND=$(mktemp)
    echo "$COMMANDS" > $FIRSTBOOT_COMMAND
    FIRSTBOOT_COMMAND="--firstboot $FIRSTBOOT_COMMAND"
fi

lvcreate -L ${ROOTSIZE} /dev/$LVG -n ${GUEST}_drive

# for encryption:
# cryptsetup luksFormat /dev/$LVG/${GUEST}_drive
# cryptsetup luksOpen /dev/$LVG/${GUEST}_drive ${GUEST}
# then use /dev/mapper/${GUEST}

IMAGE=$(mktemp)
virt-builder $DISTRO --output $IMAGE --hostname $HOSTNAME --size $ROOTSIZE $FIRSTBOOT_COMMAND $INSTALL_PACKAGES --timezone Europe/Berlin \
    --mkdir /root/.ssh/ --upload /var/lib/libvirt/authorized_keys:/root/.ssh/authorized_keys

echo "Image built. Record the root password and press enter to continue."
read
echo "Copying to LV"
dd if=$IMAGE of=/dev/$LVG/${GUEST}_drive bs=1048576

echo "Image copied. Importing."
virt-install --import --name $GUEST --ram $RAM --disk path=/dev/$LVG/${GUEST}_drive,format=raw --cpu host --vcpu $VCPUS
rm $IMAGE

###############################################################################################################################
