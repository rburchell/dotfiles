#!/bin/bash

# Setup the LV
if [ $# -lt 1 ]; then 
    echo "usage: $0 <guest>"
    echo Creates a VM.
    exit 1
fi

GUEST=$1

echo "Creating new VM ${GUEST}"

EXISTS=`lvdisplay |grep ${GUEST}_drive`

if [[ "$EXISTS" != "" ]]
then
    echo "This GUEST has already been setup on the host!"
    echo "Aborting..."
    exit 1
fi

# Exit if variables not set or on error
set -o nounset
set -o errexit

# find a logical volume group to put the LV on
LVGS=""
LVG=""
for i in $(vgs -o vg_name --noheadings); do
    LVGS="$LVGS $i"
done
case "$LVGS" in
    *\ )
        echo "Select a LVG to put the VM onto."
        read -e tmplvg

        for i in "$LVGS"; do
            if [[ "$i" == "$tmplvg" ]]; then
                LVG="$tmplvg"
            fi
        done
        ;;
    *)
        LVG=$(echo $LVGS | tr -d '[[:space:]]') # I love shell scripting.
        echo "Putting the VM onto LVG $LVG"
        ;;
esac

if [[ "$LVG" == "" ]]; then
    echo "Please tell me what LVG to put the VM onto!"
    echo "Aborting..."
    exit 1
fi

echo "Please enter LV size in GB. (8):"
read -e ROOTSIZE

if [[ "$ROOTSIZE" == "" ]]; then
    ROOTSIZE="8"
fi

DEFAULT_DISTRO="centos-7.1"
echo "Select distro ($DEFAULT_DISTRO):"
read -e DISTRO
if [[ "$DISTRO" == "" ]]; then
    DISTRO="$DEFAULT_DISTRO"
fi

echo "Enter hostname ($GUEST.vm):"
read -e HOSTNAME
if [[ "$HOSTNAME" == "" ]]; then
    HOSTNAME=${GUEST}.vm
fi

echo "Total RAM in MB? (512):"
read -e RAM
if [[ "$RAM" == "" ]]; then
    RAM=512
fi

echo "Total VCPUs? (2):"
read -e VCPUS
if [[ "$VCPUS" == "" ]]; then
    VCPUS=2
fi

echo "Encrypt VM? (n)"
read -e ENCRYPT

if [[ "$ENCRYPT" == "y" ]]; then
    echo "Setting up ENCRYPTED guest $HOSTNAME running $DISTRO"
else
    ENCRYPT="n"
    echo "Setting up guest $HOSTNAME running $DISTRO"
fi

echo " VCPUs: $VCPUS"
echo " Disk: ${ROOTSIZE}G"
echo " RAM: ${RAM}mb"
echo "Press enter to continue or ctrl-c to cancel."
read

INSTALL_PACKAGES=""
COMMANDS=""
FIRSTBOOT_COMMAND=""

if [[ "$DISTRO" == "$DEFAULT_DISTRO" ]]; then
    # don't attempt to optimize this by moving the nss-mdns install into INSTALL_PACKAGES.
    # nss-mdns lives in EPEL, which unfortunately means it needs to be done in a seperate step.
    INSTALL_PACKAGES="--install zsh,git,avahi,avahi-tools,vim,yum-cron,deltarpm"
    COMMANDS="
    yum -y update
    perl -p -i -e \"s/^apply_updates = no/apply_updates = yes/\" /etc/yum/yum-cron.conf
    yum install -y epel-release
    yum install -y nss-mdns
    yum install -y bind-utils
    yum install -y screen
    systemctl enable avahi-daemon.service
    firewall-cmd --permanent --zone=public --add-service=mdns
    reboot
    "
else
    echo "WARNING: Unrecognised distro, I may not be able to customise the setup properly."
fi

if [[ "$COMMANDS" != "" ]]; then
    FIRSTBOOT_COMMAND=$(mktemp)
    echo "$COMMANDS" > $FIRSTBOOT_COMMAND
    FIRSTBOOT_COMMAND="--firstboot $FIRSTBOOT_COMMAND"
fi

# we keep the gb value around for virt-builder's sake, so as to not ruin its
# pretty little mind.
ROOTSIZE_GB=$ROOTSIZE
# take the ROOTSIZE, convert it to mb.
ROOTSIZE=$(($ROOTSIZE * 1024))

if [[ "$ENCRYPT" == "y" ]]; then
    # for encrypted LVs, let's add an extra 10mb
    ROOTSIZE=$(($ROOTSIZE + 10))
fi

lvcreate -L ${ROOTSIZE}mb /dev/$LVG -n ${GUEST}_drive

DDTO=/dev/$LVG/${GUEST}_drive

if [[ "$ENCRYPT" == "y" ]]; then
    # for encryption:
    cryptsetup luksFormat /dev/$LVG/${GUEST}_drive
    cryptsetup luksOpen /dev/$LVG/${GUEST}_drive ${GUEST}_drive
    DDTO=/dev/mapper/${GUEST}_drive
fi

IMAGE=$(mktemp)
virt-builder $DISTRO --output $IMAGE --hostname $HOSTNAME --size ${ROOTSIZE_GB}G $FIRSTBOOT_COMMAND $INSTALL_PACKAGES --timezone Europe/Berlin \
    --mkdir /root/.ssh/ --upload /var/lib/libvirt/authorized_keys:/root/.ssh/authorized_keys

echo "Image built. Record the root password and press enter to continue."
read

# avoiding the indirection would be nice, but this isn't working on sky.
# virt-builder $DEFAULT_DISTRO --output /dev/$LVG/dns --hostname dns.vm
echo "Copying to LV"
dd if=$IMAGE of=$DDTO bs=1048576

echo "Image copied. Importing."
virt-install --import --name $GUEST --ram $RAM --disk path=$DDTO,format=raw --cpu host --vcpu $VCPUS
rm $IMAGE

###############################################################################################################################
